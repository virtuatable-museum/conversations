stages:
  - checks

default:
  cache:
    key: $(CI_COMMIT_REF_SLUG)
    paths:
      - vendor/ruby
  before_script:
    # Installs the Bundler dependencies to later get gems
    - /bin/bash -l -c "gem install bundler --no-document"
    # Sets the path used for caching purposes, and install dependencies
    - /bin/bash -l -c "bundle config set path vendor/ruby"
    # Install all dependencies and cache them
    - /bin/bash -l -c "bundle install"
    # Stores the next version in a corresponding file
    - /bin/bash -l -c "bundle exec ruby ./scripts/version.rb next > ./NEXT_VERSION"

# Executes the RSpec tests.
# TODO : store the results in an artefact.
rspec:
  stage: checks
  script:
    - /bin/bash -l -c "bundle exec rspec"


rubocop:
  stage: checks
  script:
    - /bin/bash -l -c "bundle exec rubocop"

docker:
  stage: checks
  script:
    # Logs in into docker, don't forget to create the environment variables on Gitlab
    - echo $DOCKER_PWD | docker login --username $DOCKER_USER --password-stdin
    # Stores the next version in an environment variable to access it easily
    - export NEXT_VERSION=`cat ./NEXT_VERSION`
    # Show me who executes the docker command please
    - whoami
    # Builds the image for the service.
    - docker build -t virtuatable/conversations:${NEXT_VERSION} .
    # Pushes the image to Docker HUB
    - docker push virtuatable/conversations:${NEXT_VERSION}